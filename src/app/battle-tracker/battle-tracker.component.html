<div class="container-fluid">
  <div class="row mb-2">
    <div class="col-9">
      <div class="input-group input-group-sm">
        <button type="button" class="btn btn-outline-primary" (click)="btnCreateShareSession_Click()">Create Player Session</button>
        <input type="text" class="form-control" placeholder="Join room code" [(ngModel)]="shareJoinCode">
        <button type="button" class="btn btn-outline-secondary" (click)="btnJoinShareSession_Click()">Join Session</button>
        @if (shareRoomCode) {
        <button type="button" class="btn btn-outline-danger" (click)="btnCloseShareSession_Click()">Close Room</button>
        }
      </div>
      @if (shareRoomCode) {
      <div class="small text-success mt-1">
        Room {{ shareRoomCode }}
        | Player link:
        <a [href]="shareUrl" target="_blank" rel="noopener noreferrer">{{ shareUrl }}</a>
        <button type="button" class="btn btn-link btn-sm p-0 ms-1 align-baseline" (click)="btnCopyShareUrl_Click()">
          Copy
        </button>
      </div>
      }
      @if (shareError) {
      <div class="small text-danger mt-1">{{ shareError }}</div>
      }
      @if (shareInfo) {
      <div class="small text-info mt-1">{{ shareInfo }}</div>
      }
    </div>
  </div>
  <div class="row">
    <div class="col-9">
      <div class="row">
        <div class="col-6" style="padding-left: 0">
          <div class="left btn-group" role="group">
            @if(!combatManager.started)
            {
            <button type="button" class="btn btn-primary" (click)="btnStartRound_Click()">
              Start Combat Turn
            </button>
            }
            @if(combatManager.started && combatManager.passEnded)
            {
            <button type="button" class="btn btn-primary" (click)="btnNextPass_Click()">
              {{ combatManager.hasMoreIniPasses() ? "Next Initiative Pass" : "End Combat Turn" }}
            </button>
            }
            <button type="button" class="btn btn-danger" (click)="btnReset_Click()">
              End Combat
            </button>
          </div>
        </div>
        <div class="col-6 position-relative">
          <div class="right btn-group" role="group">
            <button type="button" class="btn btn-warning" (click)="btnUndo_Click()" title="Undo"
              [disabled]="isUndoDisabled()">
              <i class="fa fa-undo fa-lg fa-inverse"></i>
            </button>
            <button type="button" class="btn btn-warning" (click)="btnRedo_Click()" title="Redo"
              [disabled]="isRedoDisabled()">
              <i class="fa fa-redo fa-lg fa-inverse"></i>
            </button>
          </div>
        </div>
      </div>
      @if(!combatManager.started && initiativePrepActive) {
      <div class="card mt-2 mb-2">
        <div class="card-header">Initiative Prep</div>
        <div class="card-body py-2">
          <div class="small mb-2">
            Pending rolls: {{ getPendingOutstandingRollCount() }}
            (Players: {{ getPendingPlayerRollCount() }}, Non-player: {{ getPendingNonPlayerRollCount() }})
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary" (click)="btnRequestPlayerRolls_Click()"
              [disabled]="getPendingPlayerRollCount() <= 0 || !shareRoomCode">
              Request Player Rolls
            </button>
            <button type="button" class="btn btn-outline-secondary" (click)="btnRollRemainingNonPlayer_Click()"
              [disabled]="getPendingNonPlayerRollCount() <= 0 || getPendingPlayerRollCount() > 0">
              Roll Remaining Non-Player
            </button>
            <button type="button" class="btn btn-outline-warning" (click)="btnForceRollOutstanding_Click()"
              [disabled]="getPendingOutstandingRollCount() <= 0">
              Force Roll Outstanding
            </button>
            <button type="button" class="btn btn-success" (click)="btnBeginCombatTurn_Click()"
              [disabled]="getPendingOutstandingRollCount() > 0">
              Begin Combat Turn
            </button>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-9">
      <div class="row bg-dark text-light">
        <div class="col-4 col-xl-2">
          <span class="h5">
            <b>Name</b>
          </span>
        </div>
        <div class="col-2 col-xl-1 text-center">
          <span class="h5">
            <b>Ini</b>
          </span>
        </div>
        <div class="col-6 col-xl-3 text-center">
          <span class="h5">
            <b>Stats / Dice Roll</b>
          </span>
        </div>
        <div class="col-xl-6"></div>
      </div>

      <div cdkDropList (cdkDropListDropped)="drop($event)">
        @for(p of combatManager.participants.items; track $index; let i = $index; let last = $last) {
        <div class="row participant" attr.id="participant{{i}}" [attr.data-indexnr]="i" [attr.data.participant]="p"
          (click)="selectActor(p)" [class]="getParticipantStyles(p)" cdkDrag>
          <div class="col-4 col-xl-2">
            <input name="name" type="text" autocomplete="off" placeholder="Name" class="form-control"
              (keydown)="inpName_KeyDown($event)" [(ngModel)]="p.name" (ngModelChange)="onParticipantUpdated()">
          </div>
          <div class="col-2 col-xl text-center">
            <span class="control-label lblIni">{{ p.getCurrentInitiative() }}</span>
          </div>
          <div class="col-6 col-xl-3 text-center">
            <div class="input-group input-group-sm gm-stats-roll-group">
              <span class="input-group-text" title="Edge">E</span>
              <input class="form-control text-center gm-stat-input" type="number"
                [ngModel]="getParticipantEdgeRatingValue(p)"
                (ngModelChange)="onParticipantEdgeRatingChanged(p, $event)" [min]="0" title="Edge">
              <span class="input-group-text" title="Reaction">R</span>
              <input class="form-control text-center gm-stat-input" type="number"
                [ngModel]="getParticipantReactionValue(p)"
                (ngModelChange)="onParticipantReactionChanged(p, $event)" [min]="0" title="Reaction">
              <span class="input-group-text" title="Intuition">I</span>
              <input class="form-control text-center gm-stat-input" type="number"
                [ngModel]="getParticipantIntuitionValue(p)"
                (ngModelChange)="onParticipantIntuitionChanged(p, $event)" [min]="0" title="Intuition">
              <input class="form-control inpDiceIni text-center gm-dice-input" name="diceIni" type="number"
                (keydown)="inpDiceIni_KeyDown($event)" (focus)="inp_Focus($event)" (input)="iniChange($event, p)"
                [(ngModel)]="p.diceIni" (ngModelChange)="onParticipantUpdated()" #field="ngModel" [min]="0">
              <div class="input-group-append">
                <button type="button" class="btn btn-dark p-0 gm-roll-btn" (click)="btnRollInitiative_Click(p)"
                  [disabled]="p.diceIni !== 0" data-toggle="tooltip" data-placement="bottom" title="Roll Initiative">
                  <i class="fas fa-dice fa-lg"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="col-7 col-xl-3 btn-group" role="group">
            @if (!p.edge
            && (!combatManager.started || (combatManager.passEnded && p.getCurrentInitiative() > 10)))
            {
            <button type="button" class="btn btn-primary" (click)="btnEdge_Click(p)">
              Seize Initiative
            </button>
            }
            @if(combatManager.started && (p.status === 1 || p.status === 2))
            {
            <button type="button" class="btn btn-primary" (click)="btnAct_Click(p, actModalContent)">
              Act
            </button>
            }
            @if (combatManager.started && p.status === 1)
            {
            <button type="button" class="btn btn-warning" (click)="btnDelay_Click(p)">
              Delay
            </button>
            }
            @if (combatManager.started && p.getCurrentInitiative() >= 1) {
            <div class="btn-group p-0" #interruptDropdown ngbDropdown autoClose="outside">
              <button ngbDropdownToggle id="interruptDropdownButton" type="button" class="btn btn-secondary"
                dropdownToggle>
                Interrupts <span class="caret"></span>
              </button>
              <div ngbDropdownMenu aria-labelledby="interruptDropdownButton">
                <h6 class="dropdown-header">Core</h6>
                @for(action of actionHandler.coreInterrupts; track action.key)
                {
                  <div class="dropdown-item" [class.disabled]="!p.canUseAction(action)">
                    @if (action.persist)
                    {
                    <div class="interrupt-row">
                      <div class="btn-group-toggle interrupt-action" data-toggle="buttons">
                        <label class=" btn btn-secondary btn-block" [class.disabled]="!p.canUseAction(action)"
                          (click)="btnAction_Click(p, action)" [attr.title]="getActionTooltip(action)">
                          <input type="checkbox" [attr.title]="getActionTooltip(action)">
                          {{ getActionLabel(action) }} ({{ action.iniMod }})
                        </label>
                      </div>
                      <button type="button" class="btn btn-outline-secondary btn-sm interrupt-twirl"
                        (click)="toggleActionDetails($event, action)" [attr.aria-expanded]="isActionDetailsOpen(action)"
                        [attr.title]="isActionDetailsOpen(action) ? 'Hide details' : 'Show details'">
                        {{ isActionDetailsOpen(action) ? "v" : ">" }}
                      </button>
                    </div>
                    }
                    @else
                    {
                    <div class="interrupt-row">
                      <button type="button" class="btn btn-secondary btn-block interrupt-action"
                        (click)="btnAction_Click(p, action)" [disabled]="!p.canUseAction(action)"
                        [attr.title]="getActionTooltip(action)">
                        {{ getActionLabel(action) }} ({{ action.iniMod }})
                      </button>
                      <button type="button" class="btn btn-outline-secondary btn-sm interrupt-twirl"
                        (click)="toggleActionDetails($event, action)" [attr.aria-expanded]="isActionDetailsOpen(action)"
                        [attr.title]="isActionDetailsOpen(action) ? 'Hide details' : 'Show details'">
                        {{ isActionDetailsOpen(action) ? "v" : ">" }}
                      </button>
                    </div>
                    }
                    @if (isActionDetailsOpen(action))
                    {
                    <div class="interrupt-details">
                      {{ getActionDetails(action) }}
                    </div>
                    }
                  </div>
                }
              </div>
            </div>
            }
            <img src="./assets/shield.svg" [hidden]="!p.isInFullDefense()" alt="Shield Icon" title="Full Defense" />
          </div>
          <div class="col-5 col-xl-3 text-right">
            <div class="btn-group" role="group">
              <button type="button"
                class="btn"
                [class.btn-outline-info]="!isParticipantClaimable(p)"
                [class.btn-info]="isParticipantClaimable(p)"
                [attr.title]="isParticipantClaimable(p) ? 'Character can be claimed by players' : 'Character cannot be claimed by players'"
                (click)="btnToggleClaimable_Click(p)">
                {{ isParticipantClaimable(p) ? "Claimable" : "Private" }}
              </button>
              <button type="button" class="btn btn-primary" (click)="btnDuplicate_Click(p)">
                <i class="fas fa-clone fa-lg fa-flip-vertical"></i>
              </button>
              @if(p.ooc){
              <button type="button" class="btn btn-success" (click)="btnEnterCombat_Click(p)">
                <i class="fa fa-sign-in-alt fa-lg fa-inverse"></i>
              </button>
              }
              @else {
              <button type="button" class="btn btn-warning" (click)="btnLeaveCombat_Click(p)">
                <i class="fa fa-sign-out-alt fa-lg fa-inverse"></i>
              </button>
              }
              <button type="button" class="btn btn-danger" (click)="btnDelete_Click(p)">
                <i class="fa fa-trash fa-lg"></i>
              </button>
            </div>
          </div>
          @if (last) {
          <span>{{ ngReady() }}</span>
          }
        </div>
        }
      </div>
      <div>
        <div colspan="8">
          <button type="submit" class="btn btn-primary" (click)="btnAddParticipant_Click()">
            <i class="fa fa-plus fa-lg"></i>
          </button>
        </div>
      </div>
      <div>
        @if (combatManager.started)
        {
        <div colspan="8">Combat Turn
          {{ combatManager.combatTurn }},
          Pass {{ combatManager.initiativePass }}, Initiative
          {{ combatManager.currentInitiative }}
        </div>
        }
        @else
        {
        Combat Turn {{ combatManager.combatTurn }}
        }
      </div>
      <div class="card mt-3">
        <div class="card-header">Action Log</div>
        <ul class="list-group list-group-flush gm-log-list" #gmLogListContainer>
          @if (shareRoomCode) {
            @if (getVisibleSharedLogEntries().length === 0) {
            <li class="list-group-item text-muted">No log entries yet.</li>
            }
            @for (entry of getVisibleSharedLogEntries(); track $index) {
            <li class="list-group-item" [class.log-entry-new]="isSharedLogEntryNew($index)">
              <strong>{{ entry.actor }}</strong>:
              <span [innerHTML]="formatLogText(entry.text)"></span>
            </li>
            }
          } @else {
            @if (getVisibleLogEntries().length === 0) {
            <li class="list-group-item text-muted">No log entries yet.</li>
            }
            @for (entry of getVisibleLogEntries(); track $index) {
            <li class="list-group-item">
              <span class="log-time">{{ entry.timestamp | date:'HH:mm:ss' }}</span>
              <span class="log-text" [class]="getLogTextClass(entry.text)">{{ entry.text }}</span>
            </li>
            }
          }
        </ul>
      </div>
    </div>

    @if (selectedActor !== null && selectActor !== undefined)
    {
    <div class="col-3 detailsBar">
      <div class="card">
        <div class="card-header">
          <h3>{{ selectedActor.name || "Selected Actor" }}</h3>
        </div>
        <div class="card-body">
          <nav ngbNav #nav="ngbNav" class="nav-tabs">
            <ng-container ngbNavItem>
              <button ngbNavLink>Condition Monitor</button>
              <ng-template ngbNavContent>
                <h4>Condition Monitor</h4>
                <div class="row">
                  <div class="col-xl-6 cm">
                    <h4>Physical</h4>
                    <app-condition-monitor [health]="selectedActor.physicalHealth"
                      [overflow]="selectedActor.overflowHealth" [painTolerance]="selectedActor.painTolerance"
                      [hasPainEditor]="selectedActor.hasPainEditor" [(damage)]="selectedActor.physicalDamage"
                      (damageChange)="onParticipantDamageChanged()">
                    </app-condition-monitor>
                  </div>
                  <div class="col-xl-6 cm">
                    <h4>Stun</h4>
                    <app-condition-monitor [health]="selectedActor.stunHealth"
                      [painTolerance]="selectedActor.painTolerance" [hasPainEditor]="selectedActor.hasPainEditor"
                      [(damage)]="selectedActor.stunDamage" (damageChange)="onParticipantDamageChanged()">
                    </app-condition-monitor>
                  </div>
                </div>
              </ng-template>
            </ng-container>
            <ng-container ngbNavItem>
              <button ngbNavLink>Stats</button>
              <ng-template ngbNavContent>
                <h4>Stats</h4>
                <div class="row">
                  <div class="col-12">
                    <span>Initiative Dices</span>
                  </div>
                  <div class="col-12">
                    <ngx-slider [(value)]="selectedActor.dices"
                      [options]="{ floor: 1, ceil: 5, step: 1, showTicks: true, tickStep: 1, animate: false}">
                    </ngx-slider>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span>Overflow</span>
                  </div>
                  <div class="col-12">
                    <ngx-slider [(value)]="selectedActor.overflowHealth"
                      [options]="{ floor: 0, ceil: 20, step: 1, showTicks: true, tickStep: 5, animate: false}">
                    </ngx-slider>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span>Physical Health</span>
                  </div>
                  <div class="col-12">
                    <ngx-slider [(value)]="selectedActor.physicalHealth"
                      [options]="{ floor: 0, ceil: 20, step: 1, showTicks: true, tickStep: 5, animate: false}">
                    </ngx-slider>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span>Stun Health</span>
                  </div>
                  <div class="col-12">
                    <ngx-slider [(value)]="selectedActor.stunHealth"
                      [options]="{ floor: 0, ceil: 20, step: 1, showTicks: true, tickStep: 5, animate: false}">
                    </ngx-slider>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span>Pain Tolerance</span>
                  </div>
                  <div class="col-12">
                    <ngx-slider [(value)]="selectedActor.painTolerance"
                      [options]="{ floor: 0, ceil: 15, step: 1, showTicks: true, tickStep: 5, animate: false}">
                    </ngx-slider>
                  </div>
                </div>
                <div class="row">
                  <div class="col-12">
                    <span>Ignore Pain</span>
                  </div>
                  <div class="col-12">
                    <label class="switch">
                      <input type="checkbox" [(ngModel)]="selectedActor.hasPainEditor" />
                      <span class="slider round"></span>
                    </label>
                  </div>
                </div>
              </ng-template>
            </ng-container>
          </nav>
          <div [ngbNavOutlet]="nav" class="mt-2"></div>
        </div>
      </div>
    </div>
    }
  </div>
</div>

<ng-template #actModalContent>
  <div class="modal-header">
    <h5 class="modal-title">
      Declare Actions @if (actModalParticipant) { - {{ actModalParticipant.name || "Participant" }} }
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeActModal()"></button>
  </div>
  <div class="modal-body">
    @if (actModalParticipant) {
    <div class="action-economy-grid mb-2">
      <div class="economy-chip">
        <span class="economy-label">Free</span>
        <span class="economy-value">{{ getFreeUsageText(actModalParticipant) }}</span>
      </div>
      <div class="economy-chip" [class.economy-blocked]="getComplexUsageText(actModalParticipant) === '1/1'">
        <span class="economy-label">Simple</span>
        <span class="economy-value">{{ getSimpleUsageText(actModalParticipant) }}</span>
      </div>
      <div class="economy-chip" [class.economy-blocked]="getSimpleUsageText(actModalParticipant) !== '0/2'">
        <span class="economy-label">Complex</span>
        <span class="economy-value">{{ getComplexUsageText(actModalParticipant) }}</span>
      </div>
    </div>
    <div class="action-validation" [class.action-validation-error]="!isDeclaredActionSelectionValid(actModalParticipant)"
      [class.action-validation-ok]="isDeclaredActionSelectionValid(actModalParticipant)">
      {{ getDeclaredActionValidationMessage(actModalParticipant) }}
    </div>
    <div class="list-group mt-3">
      @for(actionCategory of declaredActions; track actionCategory.id) {
      <button type="button" class="list-group-item list-group-item-action action-category-toggle"
        (click)="toggleDeclaredActionCategory(actionCategory.id)"
        [attr.aria-expanded]="isDeclaredActionCategoryOpen(actionCategory.id)">
        <span class="twirly">{{ isDeclaredActionCategoryOpen(actionCategory.id) ? "v" : ">" }}</span>
        <span>{{ actionCategory.category }} Actions</span>
      </button>
      @if (isDeclaredActionCategoryOpen(actionCategory.id)) {
      <div class="action-modal-group">
        @for(actionName of actionCategory.items; track actionName.name) {
        <div class="action-item-container">
          <div class="action-item-row">
            <button type="button" class="list-group-item list-group-item-action action-item"
              (click)="btnDeclaredAct_Click(actModalParticipant, actionName)"
              [class.action-item-selected]="isDeclaredActionSelected(actModalParticipant, actionName)"
              [class.action-item-disabled]="!canUseDeclaredAction(actModalParticipant, actionName)"
              [disabled]="!canUseDeclaredAction(actModalParticipant, actionName)"
              [attr.title]="getActionDisabledReason(actModalParticipant, actionName)">
              @if (isDeclaredActionSelected(actModalParticipant, actionName)) {
              <span class="action-check">x</span>
              }
              {{ actionName.name }}
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm action-item-twirl"
              (click)="toggleDeclaredActionDetails($event, actionName)"
              [attr.aria-expanded]="isDeclaredActionDetailsOpen(actionName)"
              [attr.title]="isDeclaredActionDetailsOpen(actionName) ? 'Hide details' : 'Show details'">
              {{ isDeclaredActionDetailsOpen(actionName) ? "v" : ">" }}
            </button>
          </div>
          @if (isDeclaredActionDetailsOpen(actionName)) {
          <div class="action-item-details">
            {{ getDeclaredActionDetails(actionName) }}
          </div>
          }
        </div>
        }
      </div>
      }
      }
    </div>
    }
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="closeActModal()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="submitActModal()"
      [disabled]="!actModalParticipant || !isDeclaredActionSelectionValid(actModalParticipant)">
      Submit Actions
    </button>
  </div>
</ng-template>


